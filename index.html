<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore TFR e Fondo Pensione</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e293b;
            --green: #22c55e;
            --red: #ef4444;
            --bg: #f3f4f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--primary); }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h1 { text-align: center; margin-bottom: 30px; color: #0f172a; }
        
        .section-header { 
            font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; 
            margin: 20px 0 15px 0; font-size: 1.1rem; background: #f8fafc; padding: 10px;
        }

        .grid-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1); }

        button { 
            width: 100%; padding: 15px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; 
            margin-top: 20px; transition: background 0.3s;
        }
        button:hover { background: #334155; }

        .results-box { display: none; margin-top: 40px; padding-top: 20px; border-top: 2px dashed #e2e8f0; }
        
        .summary-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { padding: 20px; background: #f8fafc; border-radius: 10px; text-align: center; border: 2px solid transparent; }
        .card.winner { border-color: var(--green); background: #f0fdf4; }
        
        .netto-highlight { font-size: 2rem; font-weight: 800; color: var(--green); margin: 10px 0; }
        .tax-badge { 
            display: inline-block; padding: 4px 8px; background: #fee2e2; color: #991b1b; 
            border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-top: 5px;
        }

        .chart-container { position: relative; height: 400px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚öñÔ∏è TFR: Azienda vs Fondo (Calcolo Auto)</h1>

    <div class="section-header">1. Dati Anagrafici ed Economici</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Et√† Attuale</label>
            <input type="number" id="eta" value="30">
        </div>
        <div class="input-group">
            <label>Et√† Pensionamento</label>
            <input type="number" id="eta_pensione" value="67">
        </div>
        <div class="input-group">
            <label>RAL Attuale (‚Ç¨)</label>
            <input type="number" id="ral" value="50000">
        </div>
        <div class="input-group">
            <label>TFR Gi√† Accantonato (‚Ç¨)</label>
            <input type="number" id="tfr_start" value="0">
        </div>
    </div>

    <div class="section-header">2. Parametri di Crescita</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Crescita Stipendio Annua (%)</label>
            <input type="number" id="growth_ral" value="1.0" step="0.1">
        </div>
        <div class="input-group">
            <label>Rendimento Azienda (%)</label>
            <input type="number" id="rate_az" value="2.85" step="0.01">
        </div>
        <div class="input-group">
            <label>Rendimento Fondo (%)</label>
            <input type="number" id="rate_fp" value="3.00" step="0.01">
        </div>
    </div>

    <button onclick="calcola()">Calcola con Tassazione Automatica</button>

    <div class="results-box" id="results">
        <div class="summary-cards">
            <!-- AZIENDA -->
            <div class="card" id="card_az">
                <h3>üè¢ Azienda</h3>
                <div class="netto-highlight" id="val_netto_az">‚Ç¨ 0</div>
                <div>Netto Stimato</div>
                <div style="font-size:0.9rem; color:#64748b; margin-top:10px;">
                    Lordo: <span id="val_lordo_az">‚Ç¨ 0</span><br>
                    Tasse: <span id="val_tasse_az" style="color:var(--red); font-weight:bold;">‚Ç¨ 0</span>
                </div>
                <div class="tax-badge" id="badge_az">Aliquota Media: 0%</div>
            </div>

            <!-- FONDO -->
            <div class="card" id="card_fp">
                <h3>üè¶ Fondo Pensione</h3>
                <div class="netto-highlight" id="val_netto_fp">‚Ç¨ 0</div>
                <div>Netto Stimato</div>
                <div style="font-size:0.9rem; color:#64748b; margin-top:10px;">
                    Lordo: <span id="val_lordo_fp">‚Ç¨ 0</span><br>
                    Tasse: <span id="val_tasse_fp" style="color:var(--red); font-weight:bold;">‚Ç¨ 0</span>
                </div>
                <div class="tax-badge" id="badge_fp">Aliquota Agevolata: 0%</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    let myChart = null;

    function toEur(num) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
    }

    // --- FUNZIONI DI TASSAZIONE AUTOMATICA ---

    // 1. Calcolo IRPEF progressiva (Scaglioni 2024/25)
    // Serve per stimare la tassazione separata TFR in Azienda
    function calcolaAliquotaIrpefMedia(ral) {
        let imposta = 0;
        
        if (ral <= 28000) {
            imposta = ral * 0.23;
        } else if (ral <= 50000) {
            // 23% sui primi 28k + 35% sul resto
            imposta = (28000 * 0.23) + ((ral - 28000) * 0.35);
        } else {
            // 23% su 28k + 35% sui successivi 22k + 43% oltre i 50k
            imposta = (28000 * 0.23) + (22000 * 0.35) + ((ral - 50000) * 0.43);
        }

        // Ritorna l'aliquota media (es. 0.28 per 28%)
        return imposta / ral;
    }

    // 2. Calcolo Aliquota Fondo Pensione (Anzianit√†)
    // Parte da 15%. Dopo il 15¬∞ anno scende di 0.30% l'anno. Minimo 9%.
    function calcolaAliquotaFp(anni_durata) {
        let aliquota = 15.0;
        
        if (anni_durata > 15) {
            let anni_extra = anni_durata - 15;
            let riduzione = anni_extra * 0.30;
            aliquota = aliquota - riduzione;
        }

        if (aliquota < 9.0) aliquota = 9.0;
        
        return aliquota / 100; // Ritorna decimale (es. 0.09)
    }

    function calcola() {
        // Input
        const eta = parseFloat(document.getElementById('eta').value);
        const eta_end = parseFloat(document.getElementById('eta_pensione').value);
        let ral = parseFloat(document.getElementById('ral').value);
        const tfr_start = parseFloat(document.getElementById('tfr_start').value);

        const p_growth = parseFloat(document.getElementById('growth_ral').value) / 100;
        const p_rate_az = parseFloat(document.getElementById('rate_az').value) / 100;
        const p_rate_fp = parseFloat(document.getElementById('rate_fp').value) / 100;

        const years = eta_end - eta;
        const coeff_tfr = 0.0691; 

        // Accumulo
        let montante_az = tfr_start;
        let montante_fp = tfr_start;

        for(let i = 1; i <= years; i++) {
            let quota_tfr = ral * coeff_tfr;

            // Formula Excel: (Montante + Versamento) * (1 + Rendimento)
            montante_az = (montante_az + quota_tfr) * (1 + p_rate_az);
            montante_fp = (montante_fp + quota_tfr) * (1 + p_rate_fp);

            // Aumento RAL (che servir√† per il calcolo tasse finale)
            ral = ral * (1 + p_growth);
        }

        // --- CALCOLO TASSE AUTOMATICO ---

        // A. Tasse Azienda (Basate su IRPEF media della RAL finale)
        // Nota: la RAL √® aumentata nel loop, quindi 'ral' ora √® la RAL finale stimata
        let tax_rate_az = calcolaAliquotaIrpefMedia(ral);
        let tasse_az = montante_az * tax_rate_az;
        let netto_az = montante_az - tasse_az;

        // B. Tasse Fondo (Basate sulla durata)
        let tax_rate_fp = calcolaAliquotaFp(years);
        let tasse_fp = montante_fp * tax_rate_fp;
        let netto_fp = montante_fp - tasse_fp;

        // --- OUTPUT UI ---
        document.getElementById('results').style.display = 'block';

        // Azienda
        document.getElementById('val_lordo_az').innerText = toEur(montante_az);
        document.getElementById('val_tasse_az').innerText = toEur(tasse_az);
        document.getElementById('val_netto_az').innerText = toEur(netto_az);
        document.getElementById('badge_az').innerText = "Aliquota Media: " + (tax_rate_az*100).toFixed(2) + "% (su RAL " + toEur(ral) + ")";

        // Fondo
        document.getElementById('val_lordo_fp').innerText = toEur(montante_fp);
        document.getElementById('val_tasse_fp').innerText = toEur(tasse_fp);
        document.getElementById('val_netto_fp').innerText = toEur(netto_fp);
        document.getElementById('badge_fp').innerText = "Aliquota Agevolata: " + (tax_rate_fp*100).toFixed(2) + "% (" + years + " anni)";

        // Winner
        const cAz = document.getElementById('card_az');
        const cFp = document.getElementById('card_fp');
        cAz.classList.remove('winner'); cFp.classList.remove('winner');
        if(netto_fp > netto_az) cFp.classList.add('winner'); else cAz.classList.add('winner');

        // Grafico Stacked
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Azienda', 'Fondo Pensione'],
                datasets: [
                    {
                        label: 'Netto',
                        data: [netto_az, netto_fp],
                        backgroundColor: '#22c55e',
                        barThickness: 50
                    },
                    {
                        label: 'Tasse',
                        data: [tasse_az, tasse_fp],
                        backgroundColor: '#ef4444',
                        barThickness: 50
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(c) { return c.dataset.label + ': ' + toEur(c.raw); }
                        }
                    }
                },
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true,
                        ticks: { callback: function(v) { return '‚Ç¨' + v/1000 + 'k'; } }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
