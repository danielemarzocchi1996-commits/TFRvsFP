<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore TFR e Fondo Pensione</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <style>
        :root {
            --primary: #0f172a; /* Blu Notte Scuro */
            --accent: #38bdf8;  /* Azzurro acceso */
            --green: #22c55e;
            --red: #ef4444;
            --card-bg: #1e293b; /* Card su tono blu */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: #cbd5e1; 
            padding: 20px; 
            margin: 0; 
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: var(--primary); 
            color: var(--text-main);
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); 
        }
        
        h1 { 
            text-align: center; 
            margin-bottom: 30px; 
            color: var(--text-main); 
            font-weight: 800; 
            font-size: 2rem;
            letter-spacing: -1px;
        }
        
        .section-title { 
            font-weight: 700; 
            border-left: 4px solid var(--accent); 
            padding-left: 15px; 
            margin: 30px 0 20px 0; 
            font-size: 1.1rem; 
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grid-wrapper { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
        }
        
        .input-group { display: flex; flex-direction: column; }
        
        label { 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            margin-bottom: 8px; 
        }
        
        /* Input generici */
        input { 
            padding: 12px; 
            border: 1px solid #334155; 
            background: #1e293b; 
            color: white;
            border-radius: 8px; 
            font-size: 1rem; 
            outline: none; 
            transition: all 0.2s; 
        }
        
        input:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); 
        }
        
        input:disabled { 
            background-color: #0f172a; 
            color: #475569; 
            border-color: #1e293b;
            cursor: not-allowed; 
        }

        /* Checkbox */
        .checkbox-wrapper {
            display: flex; align-items: center; margin-bottom: 15px; 
            background: rgba(255,255,255,0.05); 
            padding: 10px; border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .checkbox-wrapper input { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .checkbox-wrapper label { margin: 0; cursor: pointer; color: var(--text-main); font-size: 0.95rem; }

        button { 
            width: 100%; padding: 18px; 
            background: var(--accent); color: #0f172a; 
            border: none; border-radius: 10px; 
            font-size: 1.2rem; font-weight: 800; cursor: pointer; 
            margin-top: 40px; 
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        button:hover { background: #7dd3fc; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }

        /* Results */
        .results-box { 
            display: none; 
            margin-top: 50px; 
            border-top: 1px solid #334155; 
            padding-top: 40px; 
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        
        .card { 
            padding: 25px; 
            background: var(--card-bg); 
            border-radius: 16px; 
            text-align: center; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        
        .card.winner { border-color: var(--green); background: rgba(34, 197, 94, 0.1); }
        
        .card h3 { margin: 0 0 15px 0; color: var(--text-muted); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .big-netto { font-size: 2.5rem; font-weight: 800; color: var(--green); margin: 5px 0; }
        .sub-info { font-size: 0.9rem; color: var(--text-muted); margin-top: 15px; line-height: 1.8; }
        .val-lordo { color: white; font-weight: 600; }
        .val-tasse { color: var(--red); font-weight: 600; }

        .tax-details {
            font-size: 0.75rem; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px;
        }

        .chart-box { 
            position: relative; 
            height: 450px; 
            width: 100%; 
            margin-top: 30px; 
            background: #f1f5f9; /* Grigio tenue per il grafico */
            border-radius: 12px; 
            padding: 15px; 
        }

        @media (max-width: 650px) { .cards { grid-template-columns: 1fr; } .container { padding: 20px; } }
    </style>
</head>
<body onload="initInputs()">

<div class="container">
    <h1>⚖️ Calcolatore TFR Avanzato</h1>

    <!-- SEZIONE 1 -->
    <div class="section-title">1. Dati Anagrafici ed Economici</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Età Attuale</label>
            <input type="number" id="eta" value="30">
        </div>
        <div class="input-group">
            <label>Età Pensionamento</label>
            <input type="number" id="eta_pensione" value="67">
        </div>
        <div class="input-group">
            <label>RAL Attuale (€)</label>
            <!-- Nota: type="text" per permettere la formattazione con punti -->
            <input type="text" id="ral" value="50.000" oninput="formatMoneyInput(this)">
        </div>
        <div class="input-group">
            <label>TFR Accantonato (€)</label>
            <input type="text" id="tfr_start" value="0" oninput="formatMoneyInput(this)">
        </div>
    </div>

    <!-- SEZIONE 2 -->
    <div class="section-title">2. Parametri Finanziari</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Crescita Stipendio Annua (%)</label>
            <input type="number" id="growth_ral" value="1.0" step="0.1">
        </div>
        <div class="input-group">
            <label>Rendimento Lordo Azienda (%)</label>
            <input type="number" id="rate_az" value="2.85" step="0.01">
        </div>
        <div class="input-group">
            <label>Rendimento Fondo (Netto) (%)</label>
            <input type="number" id="rate_fp" value="3.00" step="0.01">
        </div>
    </div>

    <!-- SEZIONE 3 (Tassazione Avanzata) -->
    <div class="section-title">3. Tassazione</div>
    
    <div class="checkbox-wrapper">
        <input type="checkbox" id="manual_tax_toggle" onchange="toggleTaxInputs()">
        <label for="manual_tax_toggle">Modifica manuale Aliquota Media Finale</label>
    </div>

    <div class="grid-wrapper">
        <div class="input-group">
            <label>Aliquota Media Azienda (%)</label>
            <input type="number" id="tax_az_total" value="0" step="0.01" disabled title="Include IRPEF Naz + Reg + Com su capitale">
        </div>
        <div class="input-group">
            <label>Aliquota Media Fondo (%)</label>
            <input type="number" id="tax_fp_total" value="0" step="0.01" disabled title="Calcolata su Anzianità Capitale">
        </div>
    </div>

    <button onclick="calcola()">Calcola Risultato Netto</button>

    <!-- RISULTATI -->
    <div class="results-box" id="results">
        <div class="cards">
            <!-- AZIENDA -->
            <div class="card" id="card_az">
                <h3>In Azienda</h3>
                <div class="big-netto" id="res_netto_az">€ 0</div>
                <div style="color:#94a3b8">Netto in Tasca</div>
                <div class="sub-info">
                    Lordo Totale: <span class="val-lordo" id="res_lordo_az">€ 0</span><br>
                    Tasse Totali: <span class="val-tasse" id="res_tasse_az">€ 0</span><br>
                    <span class="tax-details" id="dettaglio_tax_az">Capitale: IRPEF++ | Rendimento: 17%</span>
                </div>
            </div>

            <!-- FONDO -->
            <div class="card" id="card_fp">
                <h3>Fondo Pensione</h3>
                <div class="big-netto" id="res_netto_fp">€ 0</div>
                <div style="color:#94a3b8">Netto in Tasca</div>
                <div class="sub-info">
                    Lordo Totale: <span class="val-lordo" id="res_lordo_fp">€ 0</span><br>
                    Tasse Totali: <span class="val-tasse" id="res_tasse_fp">€ 0</span><br>
                    <span class="tax-details" id="dettaglio_tax_fp">Capitale: 15-9% | Rendimento: 0%</span>
                </div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    let myChart = null;

    // --- UTILS FORMATTAZIONE ---
    function initInputs() {
        // Formatta i valori iniziali al caricamento
        formatMoneyInput(document.getElementById('ral'));
        formatMoneyInput(document.getElementById('tfr_start'));
    }

    function formatMoneyInput(input) {
        // Rimuove tutto ciò che non è numero
        let value = input.value.replace(/\D/g, ''); 
        if(value === "") { 
            input.value = ""; 
            return; 
        }
        // Formatta con i punti delle migliaia
        value = new Intl.NumberFormat('it-IT').format(value);
        input.value = value;
    }

    function getRawValue(id) {
        // Recupera il valore numerico pulito (senza punti)
        const val = document.getElementById(id).value.replace(/\./g, '');
        return parseFloat(val) || 0;
    }

    function toMoney(num) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
    }

    function toggleTaxInputs() {
        const isManual = document.getElementById('manual_tax_toggle').checked;
        const inputs = [document.getElementById('tax_az_total'), document.getElementById('tax_fp_total')];
        inputs.forEach(inp => {
            inp.disabled = !isManual;
            inp.style.backgroundColor = isManual ? "#1e293b" : "#0f172a"; 
            inp.style.borderColor = isManual ? "#38bdf8" : "#1e293b";
        });
        if (!isManual) calcola(true); 
    }

    // --- LOGICHE FISCALI AGGIORNATE ---
    
    // Calcolo IRPEF Completa (Nazionale + Regionale + Comunale)
    function getFullIrpefRate(ral) {
        // A. IRPEF NAZIONALE (Scaglioni 2024/25)
        let irpefNaz = 0;
        if (ral <= 28000) {
            irpefNaz = ral * 0.23;
        } else if (ral <= 50000) {
            irpefNaz = (28000 * 0.23) + ((ral - 28000) * 0.35);
        } else {
            irpefNaz = (28000 * 0.23) + (22000 * 0.35) + ((ral - 50000) * 0.43);
        }

        // B. ADDIZIONALE REGIONALE (Scaglioni forniti da utente)
        // 1,73% fino a 15k | 2,96% 15-28k | 3,20% 28-50k | 3,33% >50k
        let addReg = 0;
        if (ral <= 15000) {
            addReg = ral * 0.0173;
        } else if (ral <= 28000) {
            addReg = (15000 * 0.0173) + ((ral - 15000) * 0.0296);
        } else if (ral <= 50000) {
            addReg = (15000 * 0.0173) + (13000 * 0.0296) + ((ral - 28000) * 0.0320);
        } else {
            addReg = (15000 * 0.0173) + (13000 * 0.0296) + (22000 * 0.0320) + ((ral - 50000) * 0.0333);
        }

        // C. ADDIZIONALE COMUNALE (0.8% Flat)
        let addCom = ral * 0.008;

        let totaleTasse = irpefNaz + addReg + addCom;
        
        // Ritorna l'aliquota media effettiva
        return totaleTasse / ral;
    }

    function getFpRate(years) {
        let rate = 15.0;
        if (years > 15) rate -= (years - 15) * 0.30;
        if (rate < 9.0) rate = 9.0;
        return rate / 100;
    }

    function calcola(updateInputsOnly = false) {
        // Input numerici puliti
        const eta = parseFloat(document.getElementById('eta').value);
        const eta_end = parseFloat(document.getElementById('eta_pensione').value);
        const ral = getRawValue('ral'); // Uso funzione helper
        const tfr_start = getRawValue('tfr_start'); // Uso funzione helper
        
        const p_growth = parseFloat(document.getElementById('growth_ral').value) / 100;
        const p_rate_az = parseFloat(document.getElementById('rate_az').value) / 100;
        const p_rate_fp = parseFloat(document.getElementById('rate_fp').value) / 100;
        
        const years = eta_end - eta;
        const coeff_tfr = 0.0691;
        
        // Aliquote fisse sui rendimenti
        const tax_rendimenti_az = 0.17; 
        const tax_rendimenti_fp = 0.00; // 0% perché rendimento FP è netto

        let capitale_accumulato = tfr_start; 
        let montante_az = tfr_start;
        let montante_fp = tfr_start;
        let current_ral = ral;

        // Loop Accumulo
        for(let i=1; i<=years; i++) {
            let quota = current_ral * coeff_tfr;
            capitale_accumulato += quota;
            montante_az = (montante_az + quota) * (1 + p_rate_az);
            montante_fp = (montante_fp + quota) * (1 + p_rate_fp);
            current_ral = current_ral * (1 + p_growth);
        }

        let rendimento_az = montante_az - capitale_accumulato;
        let rendimento_fp = montante_fp - capitale_accumulato;

        // --- CALCOLO TASSE ---
        const isManual = document.getElementById('manual_tax_toggle').checked;
        let tasse_az_totale = 0;
        let tasse_fp_totale = 0;
        let effective_rate_az = 0;
        let effective_rate_fp = 0;

        if (!isManual) {
            // AZIENDA: IRPEF COMPLETA su Capitale + 17% su Rendimento
            let rate_irpef_completa = getFullIrpefRate(current_ral); // Include Naz+Reg+Com
            let tax_az_capitale = capitale_accumulato * rate_irpef_completa;
            let tax_az_rendimento = rendimento_az * tax_rendimenti_az;
            tasse_az_totale = tax_az_capitale + tax_az_rendimento;

            // FONDO: 15-9% su Capitale + 0% Rendimento
            let rate_fp_agevolata = getFpRate(years);
            let tax_fp_capitale = capitale_accumulato * rate_fp_agevolata;
            let tax_fp_rendimento = rendimento_fp * tax_rendimenti_fp; 
            tasse_fp_totale = tax_fp_capitale + tax_fp_rendimento;

            // Calcolo aliquota media per display
            effective_rate_az = (tasse_az_totale / montante_az) * 100;
            effective_rate_fp = (tasse_fp_totale / montante_fp) * 100;

            document.getElementById('tax_az_total').value = effective_rate_az.toFixed(2);
            document.getElementById('tax_fp_total').value = effective_rate_fp.toFixed(2);
            
            document.getElementById('dettaglio_tax_az').innerText = 
                `Capitale: ${(rate_irpef_completa*100).toFixed(2)}% (Irpef+Add) | Rendimento: 17%`;
            document.getElementById('dettaglio_tax_fp').innerText = 
                `Capitale: ${(rate_fp_agevolata*100).toFixed(1)}% (Agev.) | Rendimento: 0%`;
        } else {
            let manual_rate_az = parseFloat(document.getElementById('tax_az_total').value) / 100;
            let manual_rate_fp = parseFloat(document.getElementById('tax_fp_total').value) / 100;
            tasse_az_totale = montante_az * manual_rate_az;
            tasse_fp_totale = montante_fp * manual_rate_fp;
            document.getElementById('dettaglio_tax_az').innerText = "Aliquota Manuale";
            document.getElementById('dettaglio_tax_fp').innerText = "Aliquota Manuale";
        }

        if(updateInputsOnly) return;

        let netto_az = montante_az - tasse_az_totale;
        let netto_fp = montante_fp - tasse_fp_totale;

        // Output
        document.getElementById('results').style.display = 'block';
        document.getElementById('res_lordo_az').innerText = toMoney(montante_az);
        document.getElementById('res_tasse_az').innerText = toMoney(tasse_az_totale);
        document.getElementById('res_netto_az').innerText = toMoney(netto_az);

        document.getElementById('res_lordo_fp').innerText = toMoney(montante_fp);
        document.getElementById('res_tasse_fp').innerText = toMoney(tasse_fp_totale);
        document.getElementById('res_netto_fp').innerText = toMoney(netto_fp);

        const cAz = document.getElementById('card_az');
        const cFp = document.getElementById('card_fp');
        cAz.classList.remove('winner'); cFp.classList.remove('winner');
        if(netto_fp > netto_az) cFp.classList.add('winner'); else cAz.classList.add('winner');

        // GRAFICO
        const ctx = document.getElementById('myChart').getContext('2d');
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Azienda', 'Fondo Pensione'],
                datasets: [
                    {
                        label: 'Netto Reale',
                        data: [netto_az, netto_fp],
                        backgroundColor: '#22c55e',
                        barThickness: 60,
                        datalabels: { color: 'white', font: {weight:'bold'} }
                    },
                    {
                        label: 'Tasse Finali',
                        data: [tasse_az_totale, tasse_fp_totale],
                        backgroundColor: '#ef4444',
                        barThickness: 60,
                        datalabels: { color: 'white', font: {weight:'bold'} }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#334155' } },
                    tooltip: {
                        callbacks: { label: (c) => c.dataset.label + ': ' + toMoney(c.raw) }
                    },
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        formatter: function(value) {
                            if (value > 1000) return '€ ' + (value/1000).toFixed(0) + 'k';
                            return toMoney(value);
                        }
                    }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true, 
                        ticks: { callback: (v) => '€' + v/1000 + 'k' },
                        grid: { color: '#cbd5e1' }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
