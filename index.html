<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore TFR: Azienda vs Fondo Pensione</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: #334155;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 40px;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #475569;
        }

        input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            width: 100%;
            padding: 16px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .results-container {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cards-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .result-card {
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .result-card.winner {
            border: 2px solid var(--success);
            background: #f0fdf4;
        }

        .result-card.loser {
            border: 2px solid #e2e8f0;
            opacity: 0.9;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .net-amount {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 10px 0;
        }

        .winner .net-amount {
            color: var(--success);
        }

        .details {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #cbd5e1;
            line-height: 1.8;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-tax {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-rate {
            background: #e0f2fe;
            color: #075985;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 40px;
        }

        /* Toggle Advanced */
        .advanced-toggle {
            text-align: center;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: -20px;
            margin-bottom: 20px;
            text-decoration: underline;
        }
        
        .advanced-section {
            display: none;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .cards-wrapper {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ“Š Calcolo TFR: Azienda vs Fondo Pensione</h1>

    <div class="input-section">
        <div class="input-group">
            <label>EtÃ  Attuale</label>
            <input type="number" id="eta" value="30">
        </div>
        <div class="input-group">
            <label>EtÃ  Pensionamento</label>
            <input type="number" id="eta_pensione" value="67">
        </div>
        <div class="input-group">
            <label>RAL Attuale (â‚¬)</label>
            <input type="number" id="ral" value="50000">
        </div>
        <div class="input-group">
            <label>TFR GiÃ  Accantonato (â‚¬)</label>
            <input type="number" id="tfr_acc" value="10000">
        </div>
    </div>

    <div class="advanced-toggle" onclick="toggleAdvanced()">Apri/Chiudi Parametri Avanzati</div>
    <div class="advanced-section" id="advancedParams">
        <div class="input-section" style="margin-bottom:0; border:none; padding:0;">
            <div class="input-group">
                <label>Crescita Stipendio Annua (%)</label>
                <input type="number" id="crescita_ral" value="1.01" step="0.01">
            </div>
            <div class="input-group">
                <label>Rendimento Lordo Azienda (%)</label>
                <input type="number" id="rendimento_az" value="2.85" step="0.01">
            </div>
            <div class="input-group">
                <label>Rendimento Lordo Fondo (%)</label>
                <input type="number" id="rendimento_fp" value="3.00" step="0.01">
            </div>
            <div class="input-group">
                <label>Tassa Annuale Rendimenti FP (%)</label>
                <input type="number" id="tax_annual_fp" value="20" title="Standard 20%, Titoli stato 12.5%">
            </div>
        </div>
        <p style="font-size:0.8rem; color:#666; margin-top:10px;">
            * La tassazione finale TFR Azienda Ã¨ calcolata sugli scaglioni IRPEF della RAL finale.<br>
            * La tassazione finale Fondo Pensione varia dal 15% al 9% in base agli anni di partecipazione.
        </p>
    </div>

    <button onclick="calcola()">Calcola Previsione</button>

    <div class="results-container" id="results">
        <div class="cards-wrapper">
            <!-- Card Azienda -->
            <div class="result-card" id="card_az">
                <div class="card-title">TFR in Azienda</div>
                <div class="net-amount" id="netto_az">â‚¬ 0</div>
                <div>Netto Finale</div>
                <div class="details">
                    Lordo Accumulato: <b id="lordo_az">â‚¬ 0</b><br>
                    Tassazione Finale (IRPEF Media): <span class="badge badge-tax" id="tasse_az">â‚¬ 0</span><br>
                    <span class="badge badge-rate" id="aliquota_az">Rate: 0%</span>
                </div>
            </div>

            <!-- Card Fondo Pensione -->
            <div class="result-card" id="card_fp">
                <div class="card-title">Fondo Pensione</div>
                <div class="net-amount" id="netto_fp">â‚¬ 0</div>
                <div>Netto Finale</div>
                <div class="details">
                    Lordo Accumulato (Netto gestione): <b id="lordo_fp">â‚¬ 0</b><br>
                    Tassazione Finale (15% -> 9%): <span class="badge badge-tax" id="tasse_fp">â‚¬ 0</span><br>
                    <span class="badge badge-rate" id="aliquota_fp">Rate: 0%</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;

    function toggleAdvanced() {
        const el = document.getElementById('advancedParams');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function formatMoney(num) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
    }

    // Funzione per calcolare l'aliquota media IRPEF (Simulazione Foglio IRPEF)
    // Basato su scaglioni IRPEF standard 2024-2025 per stimare la "Tassazione Separata"
    function calcolaAliquotaIrpef(ral) {
        // Scaglioni semplificati:
        // 0 - 28.000: 23%
        // 28.000 - 50.000: 35%
        // Oltre 50.000: 43%
        
        let imposta = 0;
        if (ral <= 28000) {
            imposta = ral * 0.23;
        } else if (ral <= 50000) {
            imposta = 6440 + ((ral - 28000) * 0.35); // 6440 Ã¨ il 23% di 28k
        } else {
            imposta = 14140 + ((ral - 50000) * 0.43); // 14140 Ã¨ tasse su 50k
        }
        
        return (imposta / ral); // Ritorna percentuale decimale (es. 0.28)
    }

    function calcola() {
        // Input
        const eta = parseInt(document.getElementById('eta').value);
        const eta_pensione = parseInt(document.getElementById('eta_pensione').value);
        let ral = parseFloat(document.getElementById('ral').value);
        const tfr_start = parseFloat(document.getElementById('tfr_acc').value);

        // Parametri
        const anni_mancanti = eta_pensione - eta;
        
        // Gestione Input Crescita: se 1.01 allora Ã¨ +1%, se 1 allora 1%
        let crescita_input = parseFloat(document.getElementById('crescita_ral').value);
        let perc_crescita_ral = (crescita_input > 1) ? (crescita_input - 1) : (crescita_input / 100); 
        // Se l'utente scrive "1.01" come nell'excel, significa +1%. Se scrive "1", assumiamo 1%.
        if(crescita_input === 1.01) perc_crescita_ral = 0.01; 

        const rend_az_lordo = parseFloat(document.getElementById('rendimento_az').value) / 100;
        const rend_fp_lordo = parseFloat(document.getElementById('rendimento_fp').value) / 100;
        const tax_annual_fp = parseFloat(document.getElementById('tax_annual_fp').value) / 100;
        
        // Costanti
        const coeff_tfr = 0.0691;
        const tax_rend_az = 0.17; // 17% fisso su rivalutazione TFR

        // Variabili Accumulo
        let montante_az = tfr_start;
        let montante_fp = tfr_start;
        
        // Array per grafico
        let labels = [];
        let data_az = [];
        let data_fp = [];

        // LOOP ANNUALE
        for (let i = 1; i <= anni_mancanti; i++) {
            labels.push(eta + i);

            // 1. Calcolo TFR maturando quest'anno
            let quota_tfr = ral * coeff_tfr;

            // 2. Calcolo Azienda (Replica formula Excel utente: (Vecchio + Quota) * (1 + Rendimento))
            // Nota: La formula corretta di legge sarebbe (Vecchio * Rivalutazione) + Quota.
            // Ma usiamo la logica del tuo Excel:
            let rivalutazione_lorda_az = (montante_az + quota_tfr) * rend_az_lordo;
            let rivalutazione_netta_az = rivalutazione_lorda_az * (1 - tax_rend_az); 
            montante_az = montante_az + quota_tfr + rivalutazione_netta_az;

            // 3. Calcolo Fondo Pensione
            // Anche qui replichiamo la logica "composta" del tuo Excel
            let rendimento_lordo_fp = (montante_fp + quota_tfr) * rend_fp_lordo;
            let rendimento_netto_fp = rendimento_lordo_fp * (1 - tax_annual_fp); // Tassazione annuale sui rendimenti (es. 20%)
            montante_fp = montante_fp + quota_tfr + rendimento_netto_fp;

            // Salvataggio dati per grafico
            data_az.push(montante_az);
            data_fp.push(montante_fp);

            // Aumento RAL anno successivo
            ral = ral * (1 + perc_crescita_ral);
        }

        // --- CALCOLO TASSAZIONE FINALE ---

        // 1. Azienda: Tassazione Separata (simulata con IRPEF media sulla RAL finale)
        // Usiamo la RAL dell'ultimo anno calcolato
        let tax_rate_az = calcolaAliquotaIrpef(ral);
        let tasse_finali_az = montante_az * tax_rate_az;
        let netto_az = montante_az - tasse_finali_az;

        // 2. Fondo Pensione: Tassazione agevolata 15% -> 9%
        // Si abbassa di 0.30% per ogni anno oltre il 15esimo.
        // Anni di partecipazione = anni_mancanti (assumendo iscrizione oggi)
        // Se anni_mancanti > 35, aliquota minima 9%.
        // Base 15%. Riduzione scatta dal 16Â° anno.
        let anni_partecipazione = anni_mancanti;
        let riduzione = 0;
        if (anni_partecipazione > 15) {
            riduzione = (anni_partecipazione - 15) * 0.003;
        }
        let tax_rate_fp = 0.15 - riduzione;
        if (tax_rate_fp < 0.09) tax_rate_fp = 0.09; // Minimo 9%

        let tasse_finali_fp = montante_fp * tax_rate_fp;
        let netto_fp = montante_fp - tasse_finali_fp;

        // --- VISUALIZZAZIONE ---
        document.getElementById('results').style.display = 'block';
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

        // Azienda UI
        document.getElementById('lordo_az').innerText = formatMoney(montante_az);
        document.getElementById('tasse_az').innerText = formatMoney(tasse_finali_az);
        document.getElementById('netto_az').innerText = formatMoney(netto_az);
        document.getElementById('aliquota_az').innerText = "Aliquota media: " + (tax_rate_az * 100).toFixed(2) + "%";

        // FP UI
        document.getElementById('lordo_fp').innerText = formatMoney(montante_fp);
        document.getElementById('tasse_fp').innerText = formatMoney(tasse_finali_fp);
        document.getElementById('netto_fp').innerText = formatMoney(netto_fp);
        document.getElementById('aliquota_fp').innerText = "Aliquota finale: " + (tax_rate_fp * 100).toFixed(2) + "%";

        // Vincitore
        const cardAz = document.getElementById('card_az');
        const cardFp = document.getElementById('card_fp');
        cardAz.classList.remove('winner', 'loser');
        cardFp.classList.remove('winner', 'loser');

        if(netto_fp > netto_az) {
            cardFp.classList.add('winner');
            cardAz.classList.add('loser');
        } else {
            cardAz.classList.add('winner');
            cardFp.classList.add('loser');
        }

        // Grafico
        const ctx = document.getElementById('myChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'TFR in Azienda (Lordo)',
                        data: data_az,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.05)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Fondo Pensione (Lordo Netto Gestione)',
                        data: data_fp,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.05)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + 
                                       new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'â‚¬' + value / 1000 + 'k';
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
