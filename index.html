<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore TFR e Fondo Pensione</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e293b;
            --green: #22c55e;
            --red: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--primary); margin: 0; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; margin-bottom: 30px; color: #0f172a; font-weight: 800; letter-spacing: -0.5px; }
        
        .section-title { 
            font-weight: 700; border-left: 5px solid var(--primary); padding-left: 12px; 
            margin: 25px 0 15px 0; font-size: 1.1rem; color: #334155;
        }

        .grid-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 6px; }
        input[type="number"] { 
            padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; 
            outline: none; transition: all 0.2s; background: #fff;
        }
        input[type="number"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1); }
        input:disabled { background-color: #e2e8f0; color: #64748b; cursor: not-allowed; }

        /* Checkbox Toggle Stile */
        .checkbox-wrapper {
            display: flex; align-items: center; margin-bottom: 15px; background: #fff7ed; 
            padding: 10px; border-radius: 8px; border: 1px solid #ffedd5;
        }
        .checkbox-wrapper input { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .checkbox-wrapper label { margin: 0; cursor: pointer; color: #9a3412; font-size: 0.95rem; }

        button { 
            width: 100%; padding: 16px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; 
            margin-top: 30px; transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #334155; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }

        /* Risultati */
        .results-box { display: none; margin-top: 40px; border-top: 2px dashed #e2e8f0; padding-top: 30px; }
        
        .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { 
            padding: 25px; background: #f8fafc; border-radius: 12px; text-align: center; 
            border: 2px solid transparent; transition: all 0.3s;
        }
        .card.winner { border-color: var(--green); background: #f0fdf4; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1); }
        
        .card h3 { margin: 0 0 15px 0; color: #475569; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        .big-netto { font-size: 2.2rem; font-weight: 800; color: var(--green); margin: 5px 0; }
        .sub-info { font-size: 0.9rem; color: #64748b; margin-top: 10px; line-height: 1.6; }
        .tax-red { color: var(--red); font-weight: 700; }

        .chart-box { position: relative; height: 400px; width: 100%; }

        @media (max-width: 600px) { .cards { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>‚öñÔ∏è Analisi TFR: Azienda vs Fondo</h1>

    <!-- SEZIONE 1 -->
    <div class="section-title">1. Dati Anagrafici ed Economici</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Et√† Attuale</label>
            <input type="number" id="eta" value="30">
        </div>
        <div class="input-group">
            <label>Et√† Pensionamento</label>
            <input type="number" id="eta_pensione" value="67">
        </div>
        <div class="input-group">
            <label>RAL Attuale (‚Ç¨)</label>
            <input type="number" id="ral" value="50000">
        </div>
        <div class="input-group">
            <label>TFR Accantonato (‚Ç¨)</label>
            <input type="number" id="tfr_start" value="0">
        </div>
    </div>

    <!-- SEZIONE 2 -->
    <div class="section-title">2. Parametri di Crescita</div>
    <div class="grid-wrapper">
        <div class="input-group">
            <label>Crescita Stipendio Annua (%)</label>
            <input type="number" id="growth_ral" value="1.0" step="0.1">
        </div>
        <div class="input-group">
            <label>Rendimento TFR Azienda (%)</label>
            <input type="number" id="rate_az" value="2.85" step="0.01">
        </div>
        <div class="input-group">
            <label>Rendimento Fondo Pensione (%)</label>
            <input type="number" id="rate_fp" value="3.00" step="0.01">
        </div>
    </div>

    <!-- SEZIONE 3 (Tassazione Dinamica) -->
    <div class="section-title">3. Gestione Tassazione Finale</div>
    
    <div class="checkbox-wrapper">
        <input type="checkbox" id="manual_tax_toggle" onchange="toggleTaxInputs()">
        <label for="manual_tax_toggle">Abilita Modifica Manuale Tasse</label>
    </div>

    <div class="grid-wrapper">
        <div class="input-group">
            <label>Aliquota Azienda (%) <span id="label_auto_az" style="font-weight:normal; font-size:0.8em;">(Auto)</span></label>
            <input type="number" id="tax_az" value="0" step="0.01" disabled>
        </div>
        <div class="input-group">
            <label>Aliquota Fondo (%) <span id="label_auto_fp" style="font-weight:normal; font-size:0.8em;">(Auto)</span></label>
            <input type="number" id="tax_fp" value="0" step="0.01" disabled>
        </div>
    </div>

    <button onclick="calcola()">Calcola Previsione</button>

    <!-- RISULTATI -->
    <div class="results-box" id="results">
        <div class="cards">
            <!-- AZIENDA -->
            <div class="card" id="card_az">
                <h3>üè¢ In Azienda</h3>
                <div class="big-netto" id="res_netto_az">‚Ç¨ 0</div>
                <div>Netto Stimato</div>
                <div class="sub-info">
                    Lordo: <span id="res_lordo_az">‚Ç¨ 0</span><br>
                    <span class="tax-red">Tasse: <span id="res_tasse_az">‚Ç¨ 0</span></span>
                </div>
            </div>

            <!-- FONDO -->
            <div class="card" id="card_fp">
                <h3>üè¶ Fondo Pensione</h3>
                <div class="big-netto" id="res_netto_fp">‚Ç¨ 0</div>
                <div>Netto Stimato</div>
                <div class="sub-info">
                    Lordo: <span id="res_lordo_fp">‚Ç¨ 0</span><br>
                    <span class="tax-red">Tasse: <span id="res_tasse_fp">‚Ç¨ 0</span></span>
                </div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    let myChart = null;

    // Gestione Toggle Manuale/Automatico
    function toggleTaxInputs() {
        const isManual = document.getElementById('manual_tax_toggle').checked;
        const inputAz = document.getElementById('tax_az');
        const inputFp = document.getElementById('tax_fp');
        const labelAz = document.getElementById('label_auto_az');
        const labelFp = document.getElementById('label_auto_fp');

        if (isManual) {
            // Abilita modifica
            inputAz.disabled = false;
            inputFp.disabled = false;
            inputAz.style.backgroundColor = "#fff";
            inputFp.style.backgroundColor = "#fff";
            labelAz.innerText = "(Manuale)";
            labelFp.innerText = "(Manuale)";
        } else {
            // Disabilita e torna Auto
            inputAz.disabled = true;
            inputFp.disabled = true;
            inputAz.style.backgroundColor = "#e2e8f0";
            inputFp.style.backgroundColor = "#e2e8f0";
            labelAz.innerText = "(Auto)";
            labelFp.innerText = "(Auto)";
            // Ricalcola subito per ripristinare i valori auto nei campi
            calcola(true); 
        }
    }

    function toMoney(num) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
    }

    // --- LOGICA DI CALCOLO AUTOMATICO ---
    
    // 1. Calcolo IRPEF stimata su RAL Finale
    function getAutoTaxAz(ral) {
        let imposta = 0;
        if (ral <= 28000) imposta = ral * 0.23;
        else if (ral <= 50000) imposta = 6440 + ((ral - 28000) * 0.35);
        else imposta = 14140 + ((ral - 50000) * 0.43);
        
        return (imposta / ral) * 100; // Ritorna percentuale (es. 28.5)
    }

    // 2. Calcolo Aliquota FP basata su anni
    function getAutoTaxFp(anni) {
        let aliquota = 15.0;
        if (anni > 15) {
            aliquota -= (anni - 15) * 0.30;
        }
        if (aliquota < 9.0) aliquota = 9.0;
        return aliquota; // Ritorna percentuale (es. 9.0)
    }

    function calcola(onlyUpdateInputs = false) {
        // Input
        const eta = parseFloat(document.getElementById('eta').value);
        const eta_end = parseFloat(document.getElementById('eta_pensione').value);
        let ral = parseFloat(document.getElementById('ral').value);
        const tfr_start = parseFloat(document.getElementById('tfr_start').value);
        
        const p_growth = parseFloat(document.getElementById('growth_ral').value) / 100;
        const p_rate_az = parseFloat(document.getElementById('rate_az').value) / 100;
        const p_rate_fp = parseFloat(document.getElementById('rate_fp').value) / 100;

        const years = eta_end - eta;
        const coeff_tfr = 0.0691;

        // 1. Accumulo (Fase Comune)
        let montante_az = tfr_start;
        let montante_fp = tfr_start;
        let current_ral = ral;

        for(let i=1; i<=years; i++) {
            let quota = current_ral * coeff_tfr;
            
            // Formula Interessi Composti (Aggressiva come da Excel utente)
            montante_az = (montante_az + quota) * (1 + p_rate_az);
            montante_fp = (montante_fp + quota) * (1 + p_rate_fp);

            current_ral = current_ral * (1 + p_growth);
        }

        // 2. Gestione Tassazione (Auto vs Manuale)
        const isManual = document.getElementById('manual_tax_toggle').checked;
        let tax_pct_az = 0;
        let tax_pct_fp = 0;

        if (isManual) {
            // Prendi valori dagli input
            tax_pct_az = parseFloat(document.getElementById('tax_az').value);
            tax_pct_fp = parseFloat(document.getElementById('tax_fp').value);
        } else {
            // Calcola valori Auto
            tax_pct_az = getAutoTaxAz(current_ral); // Sulla RAL finale
            tax_pct_fp = getAutoTaxFp(years);      // Sugli anni durata
            
            // Aggiorna gli input visivamente
            document.getElementById('tax_az').value = tax_pct_az.toFixed(2);
            document.getElementById('tax_fp').value = tax_pct_fp.toFixed(2);
        }

        // Se la funzione √® chiamata solo per aggiornare gli input (es. al toggle), esci
        if(onlyUpdateInputs === true) return;

        // 3. Calcolo Finali
        let tasse_az = montante_az * (tax_pct_az / 100);
        let netto_az = montante_az - tasse_az;

        let tasse_fp = montante_fp * (tax_pct_fp / 100);
        let netto_fp = montante_fp - tasse_fp;

        // 4. Output HTML
        document.getElementById('results').style.display = 'block';
        
        document.getElementById('res_lordo_az').innerText = toMoney(montante_az);
        document.getElementById('res_tasse_az').innerText = toMoney(tasse_az);
        document.getElementById('res_netto_az').innerText = toMoney(netto_az);

        document.getElementById('res_lordo_fp').innerText = toMoney(montante_fp);
        document.getElementById('res_tasse_fp').innerText = toMoney(tasse_fp);
        document.getElementById('res_netto_fp').innerText = toMoney(netto_fp);

        // Highlight Vincitore
        const cAz = document.getElementById('card_az');
        const cFp = document.getElementById('card_fp');
        cAz.classList.remove('winner'); cFp.classList.remove('winner');
        if(netto_fp > netto_az) cFp.classList.add('winner'); else cAz.classList.add('winner');

        // 5. Grafico
        const ctx = document.getElementById('myChart').getContext('2d');
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['In Azienda', 'Fondo Pensione'],
                datasets: [
                    {
                        label: 'Netto in Tasca',
                        data: [netto_az, netto_fp],
                        backgroundColor: '#22c55e',
                        stack: 'Stack 0'
                    },
                    {
                        label: 'Tasse Pagate',
                        data: [tasse_az, tasse_fp],
                        backgroundColor: '#ef4444',
                        stack: 'Stack 0'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: { label: (c) => c.dataset.label + ': ' + toMoney(c.raw) }
                    }
                },
                scales: {
                    y: { ticks: { callback: (v) => '‚Ç¨' + v/1000 + 'k' } }
                }
            }
        });
    }
</script>

</body>
</html>
